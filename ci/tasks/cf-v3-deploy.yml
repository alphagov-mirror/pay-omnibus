platform: linux

image_resource:
  type: registry-image
  source:
    repository: rbakergds/cf-cli-v7

inputs:
  - name: omnibus
    optional: true
  - name: artefact
    optional: true

params:
  CF_API: https://api.london.cloud.service.gov.uk
  CF_USERNAME: ((cf-username))
  CF_PASSWORD: ((cf-password))
  CF_ORG:
  CF_SPACE:
  CF_DOCKER_PASSWORD:
  DOCKER_IMAGE:
  DOCKER_USERNAME:
  MANIFEST_PATH: artefact
  MANIFEST_FILE: manifest.yml
  APP_NAME:
  PATH: artefact
  VARS_FILE:
  ZDT:

run:
  path: bash
  args:
    - -c
    - |
      set -o errexit -o nounset
      cf login -a "$CF_API" \
        -u "$CF_USERNAME" -p "$CF_PASSWORD" \
        -o "$CF_ORG" -s "$CF_SPACE"

      args=()
      args+=("$APP_NAME")
      args+=(--path "$PATH")
      args+=(--manifest "$MANIFEST_PATH/$MANIFEST_FILE")
      [ -n "$VARS_FILE" ] && args+=(--vars-file "$VARS_FILE")
      [ -n "$ZDT" ] && args+=(--strategy rolling)
      [ -n "$DOCKER_USERNAME" ] && args+=(--docker-username "$DOCKER_USERNAME")
      [ -n "$DOCKER_IMAGE" ] && args+=(--docker-image "$DOCKER_IMAGE")

      cf push "${args[@]}"
