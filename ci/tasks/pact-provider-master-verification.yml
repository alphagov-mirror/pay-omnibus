platform: linux
image_resource:
  type: registry-image
  source:
    repository: rorymalcolm/pay-docker-scratches
params:
  consumer:
  provider:
  broker_username: ((pact-broker-username))
  broker_password: ((pact-broker-password))
  broker_url: "https://pay-concourse-pact-broker.cloudapps.digital"
inputs:
  - name: src
caches:
  - path: src/.m2
run:
  path: bash
  dir: src
  args:
    - -ec
    - |

      function cleanup {
        echo "CLEANUP TRIGGERED"
        clean_docker
        stop_docker
        echo "CLEANUP COMPLETE"
      }

      trap cleanup EXIT
      source /docker-helpers.sh

      pr_sha="$(git rev-list --no-merges -n 1 HEAD)"
      if pact-broker can-i-deploy --pacticipant="$provider" \
                               --version="$pr_sha" \
                               --pacticipant="$consumer" \
                               --latest="master" \
                               --broker_username="$broker_username" \
                               --broker_password="$broker_password" \
                               --broker_base_url="${broker_url}"; then
        echo "Pacts are valid"
        exit 0;
      fi

      start_docker

      cat <<'EOF' >settings.xml
      <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
            xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
            xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
                                https://maven.apache.org/xsd/settings-1.0.0.xsd">
            <localRepository>${env.MAVEN_REPO}</localRepository>
      </settings>
      EOF

      export MAVEN_REPO="$PWD/.m2"

      mvn test \
        -DrunContractTests \
        -DCONSUMER="$consumer" \
        -DPACT_CONSUMER_TAG="master" \
        -Dpact.provider.version="$pr_sha" \
        -Dpact.verifier.publishResults=true \
        -DPACT_BROKER_HOST=${broker_url} \
        -DPACT_BROKER_USERNAME="$broker_username" \
        -DPACT_BROKER_PASSWORD="$broker_password"
