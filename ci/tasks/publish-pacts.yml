platform: linux
image_resource:
  type: registry-image
  source:
    repository: dwdraju/alpine-curl-jq
inputs:
  - name: src
  - name: pacts
params:
  consumer_name:
run:
  path: sh
  args:
    - -c
    - |

      if [ ! -f src/.git/resource/head_sha ]; then
        echo "ERROR: src/.git/resource/head_sha/ does not exist."
        exit 1
      fi

      version="$(cat src/.git/resource/head_sha)"
      cd pacts
      for pact in `ls . | grep -v '\-to\-' `; do
        provider_name=$(jq .provider.name < pact)
        curl -v --fail -X PUT -H "Content-Type: application/json" \
        -d@"$pact" \
        https://pay-concourse-pact-broker.cloudapps.digital/pacts/provider/"${provider_name}"/consumer/"${consumer_name}"/version/"${version}"
      done
